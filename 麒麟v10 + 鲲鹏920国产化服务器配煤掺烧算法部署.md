### 麒麟v10 + 鲲鹏920国产化服务器配煤掺烧算法部署

#### 1.背景

博科技前期配煤掺烧一直采用`MATLAB`进行代码开发，使用`ComplierToolBox`编译成不同语言的库文件（包括但不限于`C# C++ Python Java Ruby Rust`），但是编译出来的库与当前`MATLAB`安装包相同的系统环境一致，比如安装的`MATLAB 2022b-windows-x64`版本，`ComplierToolBox`编译出来的库只能够支持`windows`，`x64`架构的环境，如果需要交叉编译其它操作系统核其它架构处理器的库，需要有对应的支持环境，目前互联网能够检索的资料较少，想短期内部署成功基本不可能。`MATLAB`在行业内专注于数值计算，其数值计算针对不同的硬件已经进行了深度的优化，比如`Intel12`代处理器的`AVX2`指令集，最新志强处理器的`AVX512`指令集，这些指令显然在`arm`上不被支持，`arm`生态还不足以让`MathWork`公司花费大量的精力去重构`Matlab`。因此`MATLAB`总体而言，其跨平台支持较差，调用`MATLAB`过程中依赖于`MCRinstaller`,`MATLAB2022b`的`MCR`解压安装，动则十几个G，十分臃肿，部署不太方便。经过多方调研，`python`的`cvxpy `支库支持持跨平台，支持混合整数规划，支持不同的求解器后端，因此采用`python`进行国产化服务器的部署是现阶段的首选方案。

#### 2.难点

`MATLAB`在学术界应用广泛，是因为其集成了诸多工程领域成熟的工具箱（优化工具箱、流体力学、自控制、集成电路、深度学习等等），科研人员的目标是完成科研任务而不需要纠结于某种语言细节。因此许多数学计算库、优化库（`CPLEX`,`MOSEK`,`GLPK_MI`,`GUROBI...`）在`MATLAB`上的使用极其方便，尤其是搭配`YALMIP`，`MATLAB`在优化求解上更是如虎添翼。对于优化器求解的一般约束，只需要学会自然的数学表达，就能在`YALMIP`上轻松实现，以下是几个典型的例子对比`YALMIP`和`cvxpy`：
**例1：**要求单一煤仓中煤种的数量不能大于2，在`YALMIP`的加持下，其实现方式如下，简单直观，不需要任何辅助变量：

```matlab
% 定义x整型变量并设置为对称矩阵
x = intvar(m, n,'full');
for i = 1:m
	constraint = [constraint nnz(x(i,:))<=2 <= 2];
end
```

但是使用`cvxpy`后，每一个约束都需要满足`DCP`（严格凸约束），对于非凸约束问题无法求解，在编写上述相同的约束，`cvxpy`需要实现为：

```python
x = cp.Variable((m, n), integer=True)
# 构造二元辅助变量z属于{0，1}
z = cp.Variable((m, n), boolean=True)
constraint2.append(x <= max_ele * z0)
constraint2.append(x >= -max_ele * (1 - z0))
constraint2.append(cp.sum(z0,1) <= 2)
```

显然没有深厚的数学功底，基本玩不转这种等效方法。

**例2：**要求煤种比例必须在集合`eles  = {0，2，3，4，6}`之种，`YALMIP`实现，直观又优雅：

```matlab
eles=[0, 2, 3, 4, 6];
constraint = ismember(x, ele);
```

换用`cvxpy`：

```python
x = cp.Variable((m, n), integer=True)
# 二元{0，1}辅助变量(x > 0  时z=1，x==0 时 z=0)
z1 = cp.Variable((m * n, eles.shape[0]), boolean=True)
constraint = [cp.sum(z1, 1) == 1, z1 @ eles == x.flatten()]
```

简直就是看天书

**例3：**要求求得的第后一组解与第前面的解不同，也就是多种优化方案的约束，`YALMIP`实现方式依旧那么优雅：

```matlab
Constraints = [Constraints, x ~= value(x)];
```

换用`cvxpy`实现十分晦涩难懂：

```python
# 待约束变量(整数)
x = cp.Variable((m, n), integer=True)
# 连续辅助变量y，X-A >= y && A-X >= y && y > 0 abs(x-A) > 0 的线性变换写法
y = cp.Variable((m, n))
# 等效于abs(x-x.value)>=0但是abs()>=0是一个非凸的问题,需要构造连续辅助变量进行调整
constraints.extend([x - x.value <= y, x.value - x <= y, y >= 0])
```

以上约束的调整足足有12项之多，对于非凸约束的线性等效写法每一项都是巨大的挑战，引用`MOSEK`的文档说法：

> In other chapters of this cookbook we have considered different classes of convex problems with continuous variables. In this chapter we consider a much wider range of non-convex problems by allowing integer variables. This technique is extremely useful in practice, and already for linear programming it covers a vast range of problems. We introduce different building blocks for integer optimization, which make it possible to model useful non-convex dependencies between variables in conic problems.It should be noted that mixed integer optimization problems are very hard (technically NP-hard), and for many practical cases an exact solution may not be found in reasonable time.

重点关注**It should be noted that mixed integer optimization problems are very hard (technically NP-hard).**这句话，其大概的意思是：【值得注意的是，混合整数规划问题十分（very）困难（技术上是NP困难）】。

#### 3.算法部署

**在麒麟`v10`操作系统上，`gcc` 版本较低为`7.3.0`，安装部分数学库会要求`libc.so` 支持的版本必须大于`GLBC_2.28`，在升级`libc.so`的过程中上层应用对`libc.so`依赖关系全部破坏，最后导致操作系统崩溃，为了避免环境污染，保证运行环境的独立性，决定采用docker进行部署。**

- 安装docker

  ```bash
  #在没有互联网的条件下，请运维人员自行查找资料安装
  yum install docker-engine.aarch64 
  ```

- 解压docker镜像（镜像由本教程提供），注意镜像为`aarch64`下的镜像，如果是`x86`架构下，最好不要复用，其性能低下。

  ```bash
  # 解压后生成文件cvxpy00.tar
  tar -zxf cvxpy_latext.tar.gz
  ```

- 导入镜像

  ```bash
  docker import cvxpy00.tar cvxpy:latest
  ```

- 启动镜像（启动脚本由本教程提供）

  ```
  start_coal_mix_optimization_serve.sh
  ```

  `start_coal_mix_optimization_serve.sh`启动脚本命令细节为：

  ```bash
  docker run -itd --name coalMixintopt -w /app -p 5051:5051 cvxpy:latest python3 -m gunicorn -c gunicorn_config.py main:app
  ```

  `-p` 参数是端口映射`-p hostport:containerport` 其中`containerport`在容器种已经固定，运维人员可以自由调整`hostport`，外部调用的时候只需要对应上上`hostport`即可。

#### 4.算法调用方式

| 项目         | 说明                                    |
| ------------ | --------------------------------------- |
| 请求地址     | http://172.168.1.110:5051/get_best_case |
| 请求方式     | POST                                    |
| 请求数据类型 | application/json                        |
| 请求参数示例 | 见请求参数                              |
| 响应参数     | 见响应参数                              |

请求参数：

```json
{
  "coalInfo": [
    [
      1.0,
      40885.0,
      4999.62248,
      1.06343,
      23.144183,
      24.32257,
      10.15199,
      1510.0,
      379.0
    ],
    [
      2.0,
      16880.0,
      4667.88325,
      0.41205,
      4.091802,
      42.33365,
      26.25259,
      1119.23196,
      328.0
    ],
    [
      3.0,
      43438.0,
      3345.95403,
      0.20619,
      3.129725,
      42.95075,
      40.32633,
      1246.7917,
      221.0
    ],
    [
      4.0,
      34121.84,
      3697.29168,
      0.30009,
      7.653919,
      41.49183,
      31.90138,
      1077.02014,
      253.5
    ],
    [
      5.0,
      31929.24,
      5054.87454,
      0.50674,
      12.151479,
      30.21797,
      18.09776,
      1179.32728,
      379.0
    ],
    [
      6.0,
      34489.25,
      5116.34979,
      1.70468,
      21.158144,
      29.77632,
      9.05154,
      1510.0,
      386.0
    ],
    [
      7.0,
      23416.0,
      4679.6018,
      0.40657,
      4.282404,
      41.84056,
      25.90487,
      1113.3565,
      328.0
    ],
    [
      8.0,
      32299.0,
      5057.16674,
      0.50944,
      10.744331,
      31.36594,
      17.90556,
      1144.49979,
      377.0
    ],
    [
      9.0,
      24648.0,
      5556.5392,
      0.3934,
      8.940918,
      30.77765,
      15.35279,
      1163.62259,
      411.0
    ],
    [
      10.0,
      40684.75,
      4912.79628,
      1.71587,
      23.038187,
      29.11839,
      9.10321,
      1510.0,
      372.0
    ],
    [
      11.0,
      21948.38,
      3702.41938,
      0.53688,
      12.863047,
      32.78624,
      29.95729,
      1233.12015,
      254.6
    ],
    [
      12.0,
      26193.62,
      4989.26903,
      0.46949,
      12.691342,
      29.11336,
      17.94949,
      1124.54164,
      379.0
    ],
    [
      13.0,
      41717.16,
      2940.08894,
      1.17862,
      6.718747,
      39.94633,
      43.2102,
      1313.78294,
      202.0
    ],
    [
      14.0,
      37969.0,
      4879.79036,
      0.80983,
      17.612055,
      30.23054,
      14.01038,
      1510.0,
      382.0
    ],
    [
      15.0,
      36561.76,
      5240.4463,
      1.5746,
      18.963347,
      30.70991,
      9.98661,
      1510.0,
      401.0
    ]
  ],
  "unitConstraint": [
    [
      4500.0,
      5000.0
    ],
    [
      0.1,
      1.5
    ],
    [
      1.0,
      20.0
    ],
    [
      0.0,
      100.0
    ],
    [
      0.0,
      100.0
    ],
    [
      1200.0,
      1450.0
    ]
  ],
  "containerConstraint": [
    [
      1,
      0,
      0,
      0,
      0,
      0,
      0,
      6000,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      2500
    ],
    [
      1,
      0,
      0,
      0,
      0,
      0,
      4500,
      6000,
      0,
      100,
      0,
      100,
      0,
      30,
      0,
      100,
      0,
      2500
    ],
    [
      1,
      0,
      0,
      0,
      0,
      0,
      4500,
      6000,
      0,
      100,
      0,
      100,
      0,
      30,
      0,
      100,
      0,
      2500
    ],
    [
      1,
      0,
      0,
      0,
      0,
      0,
      0,
      6000,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      2500
    ],
    [
      1,
      0,
      0,
      0,
      0,
      0,
      0,
      6000,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      2500
    ],
    [
      1,
      0,
      0,
      0,
      0,
      0,
      0,
      6000,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      100,
      0,
      2500
    ]
  ],
  "feederCapacity": 600,
  "mixRatio": [
    [
      0,
      1
    ],
    [
      1,
      1
    ],
    [
      1,
      2
    ]
  ],
  "mutexCoal": [
    [
      0,
      1,
      2,
      3,
      4,
      5,
      6
    ],
    [
      7,
      8,
      9,
      10
    ],
    [
      11,
      12,
      13,
      14
    ]
  ],
  "standardCoalQty": 145,
  "maxMixCoal": 4,
  "optFlag": 1,
  "topK": 1
}
```

响应参数：

```json
{
	"mixCases": [
		[
			[
				0,
				0,
				0,
				0,
				0,
				0,
				37.53902105883642,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0
			],
			[
				25.02601403922428,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				9.871022044528107e-30,
				-9.871022044528107e-30,
				12.51300701961214,
				0,
				0,
				0,
				0
			],
			[
				25.02601403922428,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				12.51300701961214,
				0,
				0,
				0,
				0
			],
			[
				0,
				0,
				0,
				0,
				0,
				0,
				18.76951052941821,
				0,
				0,
				0,
				18.76951052941821,
				0,
				0,
				0,
				0
			],
			[
				0,
				0,
				0,
				0,
				0,
				0,
				37.53902105883642,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0
			],
			[
				0,
				0,
				0,
				0,
				0,
				0,
				25.02601403922428,
				0,
				0,
				0,
				12.51300701961214,
				0,
				0,
				0,
				0
			]
		]
	],
	"mix_infos": [
		[
			4506.421901666667,
			0.5851163888888888,
			10.619071194444444,
			35.68409333333334,
			23.417334999999998,
			1231.4404125
		]
	],
	"mix_prices": [
		320.98333333333335
	]
}
```

