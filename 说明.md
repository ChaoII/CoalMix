## 配煤掺烧/采购寻优服务化部署手册

### 1.背景

博科技前期配煤掺烧一直采用`MATLAB`进行代码开发，使用`ComplierToolBox`
编译成不同语言的库文件（包括但不限于`C# C++ Python Java Ruby Rust`），但是编译出来的库与当前`MATLAB`
安装包相同的系统环境一致，比如安装的`MATLAB 2022b-windows-x64`版本，`ComplierToolBox`编译出来的库只能够支持`windows`，`x64`
架构的环境，如果需要交叉编译其它操作系统核其它架构处理器的库，需要有对应的支持环境，目前互联网能够检索的资料较少，想短期内部署成功基本不可能。`MATLAB`
在行业内专注于数值计算，其数值计算针对不同的硬件已经进行了深度的优化，比如`Intel12`代处理器的`AVX2`
指令集，最新志强处理器的`AVX512`指令集，这些指令显然在`arm`上不被支持，`arm`生态还不足以让`MathWork`
公司花费大量的精力去重构`Matlab`。因此`MATLAB`总体而言，其跨平台支持较差，调用`MATLAB`
过程中依赖于`MCRinstaller`,`MATLAB2022b`的`MCR`解压安装，动则十几个G，十分臃肿，部署不太方便。经过多方调研，`python`
的`cvxpy `支库支持持跨平台，支持混合整数规划，支持不同的求解器后端，因此采用`python`进行国产化服务器的部署是现阶段的首选方案。

### 2.难点

`MATLAB`
在学术界应用广泛，是因为其集成了诸多工程领域成熟的工具箱（优化工具箱、流体力学、自控制、集成电路、深度学习等等），科研人员的目标是完成科研任务而不需要纠结于某种语言细节。因此许多数学计算库、优化库（`CPLEX`,`MOSEK`,`GLPK_MI`,`GUROBI...`
）在`MATLAB`上的使用极其方便，尤其是搭配`YALMIP`，`MATLAB`
在优化求解上更是如虎添翼。对于优化器求解的一般约束，只需要学会自然的数学表达，就能在`YALMIP`
上轻松实现，以下是几个典型的例子对比`YALMIP`和`cvxpy`：
**例1：**要求单一煤仓中煤种的数量不能大于2，在`YALMIP`的加持下，其实现方式如下，简单直观，不需要任何辅助变量：

```matlab
% 定义x整型变量并设置为对称矩阵
x = intvar(m, n,'full');
for i = 1:m
	constraint = [constraint nnz(x(i,:))<=2 <= 2];
end
```

但是使用`cvxpy`后，每一个约束都需要满足`DCP`（严格凸约束），对于非凸约束问题无法求解，在编写上述相同的约束，`cvxpy`需要实现为：

```python
x = cp.Variable((m, n), integer=True)
# 构造二元辅助变量z属于{0，1}
z = cp.Variable((m, n), boolean=True)
constraint2.append(x <= max_ele * z0)
constraint2.append(x >= -max_ele * (1 - z0))
constraint2.append(cp.sum(z0, 1) <= 2)
```

显然没有深厚的数学功底，基本玩不转这种等效方法。

**例2：**要求煤种比例必须在集合`eles = {0，2，3，4，6}`之种，`YALMIP`实现，直观又优雅：

```matlab
eles=[0, 2, 3, 4, 6];
constraint = ismember(x, ele);
```

换用`cvxpy`：

```python
x = cp.Variable((m, n), integer=True)
# 二元{0，1}辅助变量(x > 0  时z=1，x==0 时 z=0)
z1 = cp.Variable((m * n, eles.shape[0]), boolean=True)
constraint = [cp.sum(z1, 1) == 1, z1 @ eles == x.flatten()]
```

简直就是看天书

**例3：**要求求得的第后一组解与第前面的解不同，也就是多种优化方案的约束，`YALMIP`实现方式依旧那么优雅：

```matlab
Constraints = [Constraints, x ~= value(x)];
```

换用`cvxpy`实现十分晦涩难懂：

```python
# 待约束变量(整数)
x = cp.Variable((m, n), integer=True)
# 连续辅助变量y，X-A >= y && A-X >= y && y > 0 abs(x-A) > 0 的线性变换写法
y = cp.Variable((m, n))
# 等效于abs(x-x.value)>=0但是abs()>=0是一个非凸的问题,需要构造连续辅助变量进行调整
constraints.extend([x - x.value <= y, x.value - x <= y, y >= 0])
```

以上约束的调整足足有12项之多，对于非凸约束的线性等效写法每一项都是巨大的挑战，引用`MOSEK`的文档说法：

> In other chapters of this cookbook we have considered different classes of convex problems with continuous variables.
> In this chapter we consider a much wider range of non-convex problems by allowing integer variables. This technique is
> extremely useful in practice, and already for linear programming it covers a vast range of problems. We introduce
> different building blocks for integer optimization, which make it possible to model useful non-convex dependencies
> between variables in conic problems.It should be noted that mixed integer optimization problems are very hard (
> technically NP-hard), and for many practical cases an exact solution may not be found in reasonable time.

重点关注**It should be noted that mixed integer optimization problems are very hard (technically NP-hard).**
这句话，其大概的意思是：【值得注意的是，混合整数规划问题十分（very）困难（技术上是NP困难）】。

### 3.算法部署

#### 3.1 docker部署

**在麒麟`v10`操作系统上，`gcc` 版本较低为`7.3.0`，安装部分数学库会要求`libc.so` 支持的版本必须大于`GLBC_2.28`
，在升级`libc.so`的过程中上层应用对`libc.so`依赖关系全部破坏，最后导致操作系统崩溃，为了避免环境污染，保证运行环境的独立性，决定采用docker进行部署。
**

##### 3.1.1 安装docker

  ```bash
  # 根据权限问题命令前方酌情添加sudo
  # aarch64麒麟v10
  yum install docker-engine.aarch64 
  # debain系列(统信、ubuntu、debain)
  apt install docke.io
  ```

**注意：在没有互联网的条件下，请运维人员自行查找资料安装**

##### 3.1.2 解压缩镜像文件

镜像由本教程提供，镜像会根据cpu架构的不同进行区分，如果镜像为`aarch64`下的镜像，如果是`x86`架构下，最好不要复用，其性能低下。

  ```bash
  # 解压后生成文件cvxpy00.tar
  tar -zxf cvxpy-archxx-v2.0.tar.gz
  # 如果是windows 使用压缩软件解压即可
  # 如果是aarch64 linux操作系统
  unzip -d cvxpy-archxx-v2.0.tar.zip
  ```

解压后生成：`cvxpy-archxx-v2.0.tar`,其中`archxx`是`cpu`架构，可以是`aarch64`和`x64`，比如在x86架构`CPU`下`64bit`系统
的镜像文件名为：`cvxpy-x64-v2.0.tar`，在`aarch64`架构`CPU`下`64bit`系统文件名为：`cvxpy-aarch64-v2.0.tar`

##### 3.1.3导入镜像

  ```bash
  docker import cvxpy00.tar cvxpy:latest
  ```

- 启动容器（启动脚本由本教程提供）

```bash
docker run -itd --name coal_mix_opt --restart always -w /app -p 5053:8000 cvxpy-x64:v2.0 uvicorn main:app --host 0.0.0.0 --port 8000
```

如果介意容器中的时间和宿主机的时间不一致的问题，可以在启动命令中添加参数

```bash
# debain 系列
-v /etc/localtime:/etc/localtime -v /etc/timezone:/etc/timezone
# redhat 系列
-v /etc/localtime:/etc/localtime -v /etc/timezone/timezone:/etc/timezone/timezone
```

**参数说明**

- `--name -n`: 容器名称，可以自定义
- `-w`:  设置工作目录
- `--restart always`: 容器启动后自动重启
- `--port -p`: 端口映射`-p 宿主机端口:容器端口` 其中`容器端口`在容器种已经固定，外部调用的时候只需要对应上`宿主机端口`即可。
- `uvicorn main:app --host 0.0.0.0 --port 8000`: 启动uvicorn服务，`main:app`为启动的模块，`--host 0.0.0.0 --port 8000`
  为服务端口。

#### 3.2 直接执行可执行程序进行部署

##### 3.2.1 解压文件

```bash
unzip dis_archxx.zip
```

或者直接鼠标点击解压

##### 3.2.2 执行可执行程序

```bash
#windows
colal_mix_opt.exe --host "0.0.0.0" --port 5053 --workers 1
#linux
coal_mix_opt --host "0.0.0.0" --port 5053 --workers 1
```

**参数说明**

- `--host`: 服务器地址
- `--port`: 服务器端口
- `--workers`: 进程数

### 4 算法调用方式

输入以下下地址打开`openapi`文档页面

```bash
http://localhost:5053/docs
```

#### 4.1 get_best_case

| 项目     | 说明                                          |
|--------|---------------------------------------------|
| 请求地址   | http://172.168.1.110:5051/api/get_best_case |
| 请求方式   | POST                                        |
| 请求数据类型 | application/json                            |
| 请求参数示例 | 见请求参数                                       |
| 响应参数   | 见响应参数                                       |

请求参数：

```json
{
  "coal_info": [
    [
      1.0, 45000.0, 6700.0, 0.44, 18.33, 35.21, 18.4, 1400.0, 600.0
    ], [
      2.0, 50000.0, 6800.0, 0.44, 18.33, 35.21, 18.4, 1400.0, 600.0
    ], [
      3.0, 80000.0, 4993.0, 0.44, 18.33, 34.77, 18.4, 1400.0, 500.0
    ], [
      4.0, 100000.0, 4993.0, 0.44, 18.33, 35.21, 18.4, 1400.0, 500.0
    ]
  ],
  "unit_constraint": [
    [
      3000.0, 5700.0
    ], [
      0.1, 1.5
    ], [
      10.0, 30.0
    ], [
      30.0, 36.0
    ], [
      15.0, 25.0
    ], [
      1000.0, 1400.0
    ]
  ],
  "container_constraint": [
    [
      1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 5700.0, 0.1, 1.0, 10.0, 30.0, 10.0, 36.0, 0.1, 25.0, 0.0, 1500.0
    ], [
      1.0, 2.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 5700.0, 0.1, 1.0, 10.0, 30.0, 10.0, 36.0, 0.1, 25.0, 0.0, 1500.0
    ], [
      1.0, 3.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 5700.0, 0.1, 1.0, 10.0, 30.0, 10.0, 36.0, 0.1, 25.0, 0.0, 1500.0
    ], [
      1.0, 4.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 5700.0, 0.1, 1.0, 10.0, 30.0, 10.0, 36.0, 0.1, 25.0, 0.0, 1500.0
    ], [
      1.0, 5.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 5700.0, 0.1, 1.0, 10.0, 30.0, 10.0, 36.0, 0.1, 25.0, 0.0, 1500.0
    ], [
      1.0, 6.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 5700.0, 0.1, 1.0, 10.0, 30.0, 10.0, 36.0, 0.1, 25.0, 0.0, 1500.0
    ]
  ],
  "feeder_capacity": 7200.0,
  "mix_ratio": [
    [
      1.0, 0.0
    ], [
      1.0, 1.0
    ], [
      2.0, 1.0
    ]
  ],
  "mutex_coal": [],
  "standard_coalQty": 3696.0,
  "max_mix_coal": 4,
  "opt_flag": 2,
  "top_k": 1
}
```

响应参数：

```json
{
  "code": 0,
  "data": {
    "mix_case": [
      [
        0, 0, 423.2938122402679, 423.2938122402679
      ], [
        0, 0, 0, 846.5876244805359
      ], [
        0, 0, 423.2938122402679, 423.2938122402679
      ], [
        0, 0, 0, 846.5876244805359
      ], [
        0, 0, 846.5876244805359, 0
      ], [
        0, 282.1958748268453, 564.3917496536906, 0
      ]
    ],
    "mix_info": [
      5093.388888888889, 0.44, 18.33, 35.01444444444444, 18.4, 1400
    ],
    "mix_price": 505.55555555555554
  },
  "err_msg": ""
}
```

#### 4.2 coal_mix_opt_v2

| 项目     | 说明                                            |
|--------|-----------------------------------------------|
| 请求地址   | http://172.168.1.110:5053/api/coal_mix_opt_v2 |
| 请求方式   | POST                                          |
| 请求数据类型 | application/json                              |
| 请求参数示例 | 见请求参数                                         |
| 响应参数   | 见响应参数                                         |

请求参数

```json
{
  "coal_info": [
    [
      1.0, 15407.45, 5096.0, 0.56, 16.73, 37.45, 18.1, 1200.0, 587.65
    ], [
      2.0, 2632.46, 5094.0, 0.62, 17.02, 37.29, 18.0, 1200.0, 598.67
    ], [
      3.0, 12539.08, 5015.0, 0.59, 17.51, 37.29, 18.6, 1200.0, 588.63
    ], [
      4.0, 26054.36, 5003.0, 0.54, 17.51, 37.44, 18.8, 1150.0, 569.82
    ], [
      5.0, 26203.66, 4479.0, 0.3, 36.69, 39.69, 6.4, 1200.0, 547.9
    ], [
      6.0, 3367.2, 5125.0, 0.53, 16.33, 37.18, 18.3, 1200.0, 599.68
    ], [
      7.0, 2130.0, 4889.0, 0.44, 23.48, 37.83, 12.7, 1200.0, 327.39
    ], [
      8.0, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
    ], [
      9.0, 289.84, 4177.0, 4.27, 37.0, 59.18, 11.1, 0.0, 595.19
    ], [
      10.0, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
    ]
  ],
  "container_constraint": [
    [
      1.0, 1.0, 0, 1, 0, [2, 1], [1, 1.0], 4500.0, 5500.0, 0.3, 2.0, 10.0, 30.0, 10.0, 40.0, 5.0, 20.0, 1000.0, 1500.0
    ], [
      0.0, 0.0, 1, 0, 0, 0, 0, 0.0, 7000.0, 0.0, 100.0, 0.0, 100.0, 0.0, 100.0, 0.0, 100.0, 0.0, 99999.0
    ], [
      1.0, 0.0, 0, 1, 0, [7, 6], [0, 1], 4500.0, 5500.0, 0.3, 2.0, 10.0, 30.0, 10.0, 40.0, 5.0, 20.0, 1000.0, 1500.0
    ], [
      1.0, 1.0, 0, 1, 0, 0, 0, 4500.0, 5500.0, 0.3, 2.0, 10.0, 30.0, 10.0, 40.0, 5.0, 20.0, 1000.0, 1500.0
    ], [
      0.0, 0.0, 1, 0, 0, 0, 0, 0.0, 7000.0, 0.0, 100.0, 0.0, 100.0, 0.0, 100.0, 0.0, 100.0, 0.0, 99999.0
    ], [
      1.0, 1.0, 0, 1, 0, 0, 0, 4500.0, 5500.0, 0.3, 2.0, 10.0, 30.0, 10.0, 40.0, 5.0, 20.0, 1000.0, 1500.0
    ]
  ],
  "unit_constraint": [
    [
      [
        4800.0, 7000.0
      ], [
      0.5, 2.0
    ], [
      10.0, 30.0
    ], [
      10.0, 40.0
    ], [
      5.0, 20.0
    ], [
      1000.0, 1500.0
    ]
    ], [
      [
        5000.0, 7000.0
      ], [
        0.5, 2.0
      ], [
        10.0, 30.0
      ], [
        10.0, 40.0
      ], [
        5.0, 20.0
      ], [
        1000.0, 1500.0
      ]
    ]
  ],
  "mix_ratio": [
    [
      0, 0, 1
    ], [
      0, 1, 1
    ], [0, 1, 1], [0, 1, 1], [0, 1, 1]
  ],
  "coal_quality": [
    459.38, 656.25
  ],
  "mix_coal_num": 3
}
```

响应参数

```json
{
  "code": 0,
  "data": {
    "mix_rates": [[0, 1, 1, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 2, 0, 0, 0], [0, 1, 0, 0, 0, 0, 1, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 1, 0, 0, 0, 0, 1, 0, 0, 0]],
    "mix_cases": [[[-0.0, 57.4225, 57.4225, -0.0, -0.0, -0.0, -0.0, -0.0, 0.0, -0.0], [-0.0, -0.0, -0.0, -0.0, -0.0, -0.0, 114.845, -0.0, 0.0, -0.0], [-0.0, 57.4225, -0.0, -0.0, -0.0, -0.0, 57.4225, -0.0, 0.0, -0.0], [-0.0, 57.4225, -0.0, -0.0, -0.0, -0.0, 57.4225, -0.0, 0.0, -0.0]], [[-0.0, 109.375, 109.375, -0.0, -0.0, -0.0, -0.0, -0.0, 0.0, -0.0], [-0.0, 109.375, -0.0, -0.0, -0.0, -0.0, 109.375, -0.0, 0.0, -0.0], [-0.0, 109.375, -0.0, -0.0, -0.0, -0.0, 109.375, -0.0, 0.0, -0.0]]],
    "mix_infos": [[4981.625, 0.52625, 20.31125, 37.56, 15.424999999999999, 1200.0], [5012.5, 0.5549999999999999, 19.255, 37.47, 16.333333333333332, 1200.0]],
    "mix_prices": [461.775, 506.56999999999994]
  },
  "err_msg": ""
}
```

#### 4.3 purchase_opt

| 项目     | 说明                                         |
|--------|--------------------------------------------|
| 请求地址   | http://172.168.1.110:5053/api/purchase_opt |
| 请求方式   | POST                                       |
| 请求数据类型 | application/json                           |
| 请求参数示例 | 见请求参数                                      |
| 响应参数   | 见响应参数                                      |

请求参数

```json
{
  "ending_inventory": [
    20, 4072, 0.9, 19
  ],
  "burning_constraint": [
    16.4355, 4020, 0.9, 20
  ],
  "total_purchase": 18.4355,
  "replace_rate": 0.3,
  "max_purchase_kinds": 50,
  "market_coal": [
    [
      0, 457, 4971, 0.7, 21, 0, 0, 10
    ], [
      1, 552, 4785, 0.7, 17, 2, 0, 10
    ], [
      2, 567, 5120, 0.6, 20, 1, 0, 10
    ], [
      3, 546, 4800, 0.6, 18, 0, 0, 10
    ], [
      4, 546, 5120, 0.8, 22, 0, 0, 50
    ], [
      5, 571, 4576, 0.2, 21, 0, 0, 50
    ], [
      6, 560, 4800, 0.4, 15, 0, 0, 10
    ], [
      7, 543, 4678, 0.5, 10.4, 0, 0, 10
    ], [
      8, 541, 4798, 0.6, 19, 0, 0, 10
    ], [
      9, 556, 4454, 0.5, 20, 0, 0, 10
    ], [
      10, 567, 5100, 0.8, 22, 0, 0, 50
    ], [
      11, 574, 4978, 0.9, 21, 0, 0, 50
    ], [
      12, 531, 5134, 0.9, 21, 0, 0, 22
    ], [
      13, 511, 4879, 0.8, 20, 0, 0, 30
    ], [
      14, 569, 4987, 0.9, 20, 0, 0, 23
    ], [
      15, 567, 5000, 0.6, 23, 0, 0, 23
    ]
  ],
  "stock_coal": [
    [
      0, 521, 4872, 0.9, 21, 1.2
    ], [
      1, 562, 5124, 0.98, 25, 0.172348
    ], [
      2, 542, 4562, 0.7, 24, 2.657768
    ], [
      3, 664, 4890, 0.78, 23, 0.172348
    ], [
      4, 567, 5100, 0.89, 21.5, 0.02975
    ], [
      5, 642, 4978, 0.78, 22.5, 0.713474
    ], [
      6, 578, 5000, 0.8, 22, 0.408209
    ], [
      7, 587, 4896, 0.79, 23, 0.36046
    ], [
      8, 578, 4975, 0.98, 24, 0.53407
    ], [
      9, 664, 4962, 0.96, 24.09, 1.320696
    ], [
      10, 569.89, 4567, 0.6, 26.7, 1.073522
    ], [
      11, 642.28, 5500, 0.97, 22, 1.89255
    ], [
      12, 557.9, 4876, 0.96, 24.8, 2.796348
    ], [
      13, 556.78, 5510, 0.68, 25.9, 1.600086
    ], [
      14, 674.8, 4897, 0.56, 25.9, 0.687672
    ], [
      15, 678.9, 5321, 0.57, 23.2, 1.058048
    ], [
      16, 782.4, 5234, 0.75, 22.9, 1.481876
    ]
  ]
}
```

响应参数证明

```json
{
  "code": 0,
  "data": {
    "purchase_mount": [10.0, 2.0, 1.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, 5.435500000000001, -0.0, -0.0],
    "stocking_mount": [[0.0, 1.2], [1.0, 0.172348], [2.0, 2.657768], [3.0, 0.172348], [4.0, 0.02975], [5.0, 0.6984360000000001]]
  },
  "err_msg": ""
}

```

